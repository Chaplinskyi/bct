<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="uk">

<head>
    <meta charset="UTF-8">
    <title>BCT - Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css"> <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Додаткові стилі для мобільної оптимізації */
        .stat-card .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, .15) !important;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .list-group-item-action:hover {
            background-color: #f8f9fa;
        }

        /* Зменшуємо відступи в таблиці на малих екранах */
        @media (max-width: 767.98px) {
            .table th, .table td {
                padding: 0.5rem 0.4rem; /* Зменшені відступи */
                font-size: 0.85rem; /* Трохи менший шрифт */
            }
            .stat-card .fs-2 {
                font-size: 1.75rem !important; /* Зменшуємо іконки статистики */
            }
            .logo-title-container img {
                width: 80px; /* Зменшуємо логотип */
                height: 80px;
            }
            .logo-title-container h1 {
                font-size: 1.75rem; /* Зменшуємо заголовок */
            }
            /* Зробимо картки панелі керування трохи компактнішими */
            .list-group-item-action .fs-4 {
                font-size: 1.3rem !important;
            }
            .list-group-item-action .fs-6 {
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>

<body class="bg-light">
<div class="container-fluid py-3 p-lg-4">

    <div class="logo-title-container mb-4 text-center">
        <img src="/images/logo.png" alt="Логотип">
        <h1 class="text-success m-0">BCT - Admin Dashboard</h1>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show mx-lg-3" role="alert">
        <span th:text="${error}">Штрих Код не знайдено!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div class="card shadow-sm mb-4 mx-lg-3">
        <div class="card-body p-3 p-md-4">
            <form th:action="@{/barcodes/search}" method="get" role="search">
                <div class="input-group">
                    <input name="code" class="form-control" type="search" placeholder="Шукати Штрих Код..." aria-label="Search" required>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-search me-1"></i> Пошук
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4 mx-lg-1">

        <div class="col-lg-8">

            <div class="card shadow-sm mb-4" th:if="${not #lists.isEmpty(outdatedBarcodes)}">
                <div class="card-header bg-warning-subtle text-warning-emphasis fs-5">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Застарілий Матеріал (більше 1 року)
                </div>
                <div class="card-body p-2 p-md-3"> <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover m-0 text-center align-middle small">
                        <thead class="table-danger-subtle">
                        <tr>
                            <th class="d-none d-sm-table-cell">№</th>
                            <th>Штрих Код</th>
                            <th class="d-none d-md-table-cell">APN</th> <th>К-сть</th>
                            <th>Локація</th>
                            <th class="d-none d-sm-table-cell">Дата дод.</th> </tr>
                        </thead>
                        <tbody>
                        <tr th:each="barcode, iterStat : ${outdatedBarcodes}">
                            <td class="d-none d-sm-table-cell" th:text="${iterStat.count}">1</td>
                            <td>
                                <span th:text="${barcode.code}">123456</span>
                                <a th:href="@{'/barcodes/' + ${barcode.id}}" class="ms-1 text-decoration-none text-success" title="Деталі">
                                    <i class="bi bi-info-circle small"></i>
                                </a>
                            </td>
                            <td class="d-none d-md-table-cell" th:text="${barcode.apn}">M3130001</td>
                            <td th:text="${barcode.quantity}">18000</td>
                            <td>
                                    <span th:if="${barcode.location == 'prestock' or barcode.location == 'wires'}"
                                          class="badge bg-success" th:text="${barcode.location}"></span>
                                <span th:if="${barcode.location != 'prestock' and barcode.location != 'wires'}"
                                      th:text="${barcode.location}"></span>
                            </td>
                            <td class="d-none d-sm-table-cell" th:text="${#temporals.format(barcode.creationDate, 'dd.MM.yy')}">09.06.25</td> </tr>
                        </tbody>
                    </table>
                </div>
                    <div class="text-center mt-3">
                        <a th:href="@{/barcodes/download/outdated}" class="btn btn-sm btn-warning text-white">
                            <i class="bi bi-download me-1"></i> Завантажити список
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary-subtle text-primary-emphasis fs-5">
                    <i class="bi bi-bar-chart-line-fill me-2"></i>Статистика
                </div>
                <div class="card-body">
                    <div class="row text-center g-3 mb-4 stat-card">
                        <div class="col-6 col-md-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column justify-content-center px-1 py-2"> <i class="bi bi-box-seam fs-2 text-primary"></i> <h4 class="card-title my-1 fs-5" th:text="${stats.totalInDb}">0</h4> <p class="card-text text-muted small mb-0">На складі</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column justify-content-center px-1 py-2">
                                    <i class="bi bi-plus-circle-dotted fs-2 text-success"></i>
                                    <h4 class="card-title my-1 fs-5" th:text="${stats.totalAdded}">0</h4>
                                    <p class="card-text text-muted small mb-0">Всього додано</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column justify-content-center px-1 py-2">
                                    <i class="bi bi-dash-circle-dotted fs-2 text-danger"></i>
                                    <h4 class="card-title my-1 fs-5" th:text="${stats.totalDiscarded}">0</h4>
                                    <p class="card-text text-muted small mb-0">Всього списано</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body d-flex flex-column justify-content-center px-1 py-2">
                                    <i class="bi bi-geo-alt-fill fs-2 text-info"></i>
                                    <h4 class="card-title my-1 fs-5" th:text="${stats.mostPopularLocation}">-</h4>
                                    <p class="card-text text-muted small mb-0">Топ локація</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3 mb-md-0">
                            <h5 class="text-center text-muted fw-normal fs-6">Додано (12 міс.)</h5> <canvas id="addedChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-center text-muted fw-normal fs-6">Списано (12 міс.)</h5> <canvas id="discardedChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

        </div> <div class="col-lg-4">

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success-subtle text-success-emphasis fs-5">
                <i class="bi bi-database-fill-gear me-2"></i>Панель БД
            </div>
            <div class="list-group list-group-flush">
                <a th:href="@{/barcodes}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-database me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">База Даних</span>
                </a>
                <a th:href="@{/upload-new}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-file-earmark-plus-fill me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">Додати ШК</span>
                </a>
                <a th:href="@{/transfer}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-arrow-right-square-fill me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">Перенести</span>
                </a>
                <a th:href="@{/upload-discarded}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-file-earmark-minus-fill me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">Списати ШК</span>
                </a>
                <a th:href="@{/discarded}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-clipboard-data-fill me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">Облік списаних</span>
                </a>
                <a th:href="@{/barcodes/history}" class="list-group-item list-group-item-action d-flex align-items-center py-2">
                    <i class="bi bi-archive-fill me-3 fs-4 text-success"></i>
                    <span class="fs-6 fw-medium">Історія ШК</span>
                </a>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info-subtle text-info-emphasis fs-5">
                <i class="bi bi-hdd-stack-fill me-2"></i>Склади
            </div>
            <div class="card-body d-grid gap-2">
                <a th:href="@{/warehouse}" class="btn btn-md btn-info text-white">
                    <i class="bi bi-boxes me-2"></i> Матеріали
                </a>
                <a href="http://dws.dss2.tk/" target="_blank" class="btn btn-md btn-warning text-white">
                    <i class="bi bi-diagram-3-fill me-2"></i> Провідники (DWS)
                </a>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary-subtle text-secondary-emphasis fs-5">
                <i class="bi bi-arrow-repeat me-2"></i>Останні Рухи
            </div>
            <div th:if="${not #lists.isEmpty(recentActivities)}" class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                <div th:each="activity : ${recentActivities}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start py-2">
                    <div class="ms-2 me-auto small">
                        <div class="fw-bold">
                            <i th:if="${activity.type == 'location'}" class="bi bi-geo-alt-fill me-1 text-success"></i>
                            <i th:if="${activity.type == 'status'}" class="bi bi-toggles me-1 text-success"></i>
                            <a th:href="@{'/barcodes/' + ${activity.barcodeId}}" class="text-decoration-none text-success" th:text="${activity.barcodeCode}">123456789</a>
                        </div>
                        <span th:text="${activity.description}" class="text-break">Переміщено з prestock на SK 1</span>
                    </div>
                    <span class="badge bg-light text-muted rounded-pill ms-2" style="white-space: nowrap;"
                          th:text="${#temporals.format(activity.timestamp, 'HH:mm dd.MM')}">10:30 26.10</span>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(recentActivities)}" class="card-body text-center text-muted">
                Немає останніх рухів.
            </div>
        </div>

    </div> </div> </div> <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*<![CDATA[*/

    // Запускаємо код тільки після того, як вся сторінка завантажилась
    document.addEventListener("DOMContentLoaded", function() {

        // Перевіряємо, чи Chart завантажився
        if (typeof Chart !== 'undefined') {

            // Дані для першого графіку (Додані)
            const addedData = {
                labels: /*[[${addedChartData.labels}]]*/ [],
                datasets: [{
                    label: 'Додано',
                    data: /*[[${addedChartData.data}]]*/ [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderWidth: 1,
                    fill: true,
                    tension: 0.1
                }]
            };

            // Дані для другого графіку (Списані)
            const discardedData = {
                labels: /*[[${discardedChartData.labels}]]*/ [],
                datasets: [{
                    label: 'Списано',
                    data: /*[[${discardedChartData.data}]]*/ [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 1,
                    fill: true,
                    tension: 0.1
                }]
            };

            const options = {
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            };

            // Ініціалізація
            try {
                new Chart(
                    document.getElementById('addedChart'),
                    {
                        type: 'line',
                        data: addedData,
                        options: options
                    }
                );

                new Chart(
                    document.getElementById('discardedChart'),
                    {
                        type: 'line',
                        data: discardedData,
                        options: options
                    }
                );
            } catch (e) {
                console.error("Помилка при ініціалізації графіків: ", e);
            }

        } else {
            console.error("Бібліотека Chart.js не завантажилась! Перевірте підключення до Інтернету або налаштування AdBlock.");
        }

    }); // <-- Кінець 'DOMContentLoaded'
    /*]]>*/
</script>
</body>
</html>